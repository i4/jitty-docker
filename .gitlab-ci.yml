### TODO:
# include a check whether all Dockerfile.* files are referenced as a build step

stages:
  - build
  - publish

## default variables - may be overwritten from projects variables
variables:
  REGISTRY: hub.docker.com
  NAMESPACE: $USER
  IMAGE: jittytest
  TAG: $CI_JOB_NAME

.kaniko:
  stage: build
  script:
  - echo "{\"auths\":{\"https://$REGISTRY/v1/\":{\"auth\":\"$AUTH\"}}}" > /kaniko/.docker/config.json
  - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile.$TAG --destination $IMAGE:$TAG
  only:
    variables:
    - $REGISTRY
    - $NAMESPACE
    - $IMAGE
    - $TAG
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  artifacts:
    paths:
    - docker-images/*


## Add new Dockerfiles as jobs below

#clang4-x64:
#  extends: [ .kaniko ]
#  only:
#    changes:
#    - Dockerfile.clang4-x64
#
#clang5-x64:
#  extends: [ .kaniko ]
#  only:
#    changes:
#    - Dockerfile.clang5-x64
#
#clang6-x64:
#  extends: [ .kaniko ]
#  only:
#    changes:
#    - Dockerfile.clang6-x64
#
#clang7-x64:
#  extends: [ .kaniko ]
#  only:
#    changes:
#    - Dockerfile.clang7-x64
#
#clang8-x64:
#  extends: [ .kaniko ]
#  only:
#    changes:
#    - Dockerfile.clang8-x64

clang9-x64:
  extends: [ .kaniko ]
  only:
    changes:
     - Dockerfile.clang9-x64

#clang10-x64:
#  extends: [ .kaniko ]
#  only:
#    changes:
#    - Dockerfile.clang10-x64
